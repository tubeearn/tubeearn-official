<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gift Revenue Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; }
    h2 { color: #2a2a2a; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    .summary { margin-top: 20px; font-weight: bold; }
    button { margin-top: 20px; padding: 10px 20px; cursor: pointer; }
  </style>
</head>
<body>

  <h2>üéÅ Gift Revenue Dashboard</h2>

  <div class="summary" id="summary"></div>

  <table id="transactionTable">
    <thead>
      <tr>
        <th>User ID</th>
        <th>Username</th>
        <th>Gift Type</th>
        <th>Gift Value</th>
        <th>Owner (20%)</th>
        <th>User (80%)</th>
        <th>Date</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button onclick="downloadPDF()">üìÑ Download PDF</button>

  <script>
    const { createClient } = supabase;
    const supabaseUrl = 'https://ejbvidirnsjvadvekede.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqYnZpZGlybnNqdmFkdmVrZWRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2MTA3ODMsImV4cCI6MjA2OTE4Njc4M30.KoCt8f2bXjn3843XOsRMLwyZ0lKpARkrRqb_GXlGfUs';
    const supabase = createClient(supabaseUrl, supabaseKey);

    async function loadData() {
      const { data, error } = await supabase
        .from('wallet-transactions')
        .select('*');

      if (error) {
        document.getElementById('summary').innerText = 'Error loading data.';
        return;
      }

      let total = 0;
      let ownerCut = 0;
      let userCut = 0;
      const tbody = document.querySelector('#transactionTable tbody');
      tbody.innerHTML = '';

      data.forEach(item => {
        const giftValue = parseFloat(item.gift_value || 0);
        const owner = giftValue * 0.2;
        const user = giftValue * 0.8;
        total += giftValue;
        ownerCut += owner;
        userCut += user;

        const row = `
          <tr>
            <td>${item.user_id}</td>
            <td>${item.username || '-'}</td>
            <td>${item.gift_type}</td>
            <td>‚Çπ${giftValue.toFixed(2)}</td>
            <td>‚Çπ${owner.toFixed(2)}</td>
            <td>‚Çπ${user.toFixed(2)}</td>
            <td>${item.date || '-'}</td>
          </tr>
        `;
        tbody.innerHTML += row;
      });

      document.getElementById('summary').innerHTML = `
        Total Revenue: ‚Çπ${total.toFixed(2)}<br>
        Owner Share (20%): ‚Çπ${ownerCut.toFixed(2)}<br>
        User Share (80%): ‚Çπ${userCut.toFixed(2)}
      `;
    }

    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Gift Revenue Report", 14, 16);
      doc.autoTable({ html: '#transactionTable', startY: 20 });
      doc.save("gift-revenue-report.pdf");
    }

    loadData();
  </script>

  <!-- AutoTable plugin for jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
</body>
</html>
